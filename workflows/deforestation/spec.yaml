id: deforestation
requirements:
  - name: ecoscope-workflows-core
    version: "*"
    channel: https://repo.prefix.dev/ecoscope-workflows/
  - name: ecoscope-workflows-ext-gamm-trend-analysis
    version: "*"
    channel: file:///tmp/ecoscope-workflows-custom/release/artifacts/


workflow:
  - name: Set Workflow Details
    id: workflow_details
    task: set_workflow_details
  - name: Time Range
    id: time_range
    task: set_time_range
    partial:
      time_format: "%d %b %Y %H:%M:%S %Z"
  - name: Set Groupers
    id: groupers
    task: set_groupers
  - name: Get Time Series Data
    id: time_series_data
    task: get_observations
    partial:
      time_range: ${{ workflow.time_range.return }}
  - name: Fit GAMM Model
    id: gamm_model
    task: fit_gamm_model
    partial:
      dataframe: ${{ workflow.time_series_data.return }}
      time_column: "recorded_at"
      value_column: "value"
      optimize_alpha: true
      metric: "aic"
  - name: Generate Trend Predictions
    id: trend_predictions
    task: predict_gamm_trends
    partial:
      model_params: ${{ workflow.gamm_model.return }}
      include_ci: true
  - name: Create Trend Chart
    id: trend_chart
    task: draw_line_chart
    partial:
      dataframe: ${{ workflow.trend_predictions.return }}
      x_column: "time"
      y_column: "predicted"
      line_kwargs:
        shape: "spline"
      layout_kwargs:
        xaxis:
          title: "Time"
        yaxis:
          title: "Trend"
        hovermode: "closest"
  - name: Create Trend Chart Widget
    id: trend_chart_widget
    task: create_plot_widget_single_view
    partial:
      title: "GAMM Trend Analysis"
    map:
      argnames: [view, data]
      argvalues: ${{ workflow.trend_chart.return }}
  - name: Create GAMM Dashboard
    id: gamm_dashboard
    task: gather_dashboard
    partial:
      details: ${{ workflow.workflow_details.return}}
      widgets:
        - ${{ workflow.trend_chart_widget.return }}
      time_range: ${{ workflow.time_range.return}}
      groupers: ${{ workflow.groupers.return }}

